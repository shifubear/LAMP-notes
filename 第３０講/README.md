# 第３０講

## インターネットに公開する前に

前回までの授業で簡単掲示板が完成しました！開発が自分のパソコンなどのローカル環境で終了したら、次はこれをネットに公開します。サーバーを公開すれば、たくさんの人が頑張って作ったサイトを使ってくれます。しかし、中には悪意を持ってインターネットを使用する人がいます。そのようなことを考慮してサイトを公開する前にいくつか準備をする必要があります。

### 重要な情報をファイルに入れない

みんなが作ったサイトの内容はすべてサーバーに入っているファイルにすぎません。クロームのデベロッパーツールを使うとHTMLのファイルのソースコードをすべて見ることができます。それと違ってPHPのファイルはサーバー内で処理されて、結果だけ送られるので基本的にはその中身がみられる心配はないはずです。しかし、それでもサーバー自体はネットにつながっているので、少しした誤作動などを利用してそのファイルの中身を見れる人がいるかもしれません。

このような事態を避けるために、重要な内容は別のファイルに入れておきましょう。PHPは複数のファイルにコード分けることができます。分けたファイルを組み合わせるためには次のコマンドを使います。

```php
require_once(読み込むファイル名)
```

試しに新しく`db_info.php`というファイルを作り、ログインのための内容をそのファイルに入れましょう。

`db_info.php`
```php
<?php
$dsn = 'mysql:dbname=db1;host=localhost';
$user = 'root';
$password = 'password';
?>
```

サーバー内で公開されるファイルは`/var/www/`ディレクトリー以下の内容だと考えると安全です。この性質を利用して、このファイルを安全な場所に入れておけば大事な情報が読み込まれる心配は大きく減ります。

### SQLインジェクション

これでファイルに書いてある重要な情報は守ることができました。しかしまだ安心するには早いです。ネットを使用する人の中にはあらゆる工夫をしながら情報を盗んだり妨害してきました。ここでは初期のネットのウエブ開発者の頭を抱えさせた攻撃、SQLインジェクションを紹介します。

まずは`keijiban_delete.php`のクエリのコードを覗いてみましょう。

```php
$number = $_POST["bangou"];

$dbh->query("DELETE FROM keijiban_tb1 WHERE bangou = $number;");
```

このプログラムは掲示板の使用者が数字を入れてくれることを仮定して作ったものです。しかし、SQLについて少し知っている人がこのサイトを使うとこのようなことができてしまいます。

悪意あるユーザが以下の入力をしたらどうなるかを考えてみましょう。

```sql
1 OR 1=1
```

この入力がクエリに組み込まれたときに、クエリ分は以下のようになります。

```php
$dbh->query("DELETE FROM keijiban_tb1 WHERE bangou = 1 OR 1 = 1;");
```

WHEREの後の条件式に注目してみてください。

```sql
bangou = 1 OR 1 = 1
```

これはどちらかの条件が満たされていればOKというOR文を使っています。右の式は1=1という必ず正しい式です。こうなると、クエリはこのように省略されます。

```php
$dbh->query("DELETE FROM keijiban_tb1;");
```

そうなると掲示板内のすべてのデータが消されてしまいます。こんな簡単に全データを知らないユーザに消されてしまってはサイトとして成り立ちません。これ以外にも、SQLインジェクションを使えばほかのユーザ名でログインができたり、貴重なデータを盗んだり変更したりすることも可能になってしまいます。

これを止める基本的な方法には`=`, `"`, `'`, `&`のような記号を入力したらその入力を受け入れないように書き換えるものがあります。

それに便利なのが「正規表現」という文字列検索のためのツールです。教科書の４６３ページに行けば使い方がいろいろあるので参考にしてください。正規表現で文字列を確認するための関数に「`preg_match()`」というものがあります。

書式）
```
preg_match(正規表現, 調査する文字列)
```

正規表現が調査する文字列とマッチしてれば、条件が満たされ、その結果を条件分岐に使用することができます。

一般的に正規表現は「/」で囲います。

例）

AからZまでの文字が一つでも入っている。

```
"/[A-Z]/"
```

使用例

```php
if (preg_match("/[A-Z]/", "Apple")) {
    print "含みます。";
} else {
    print "含みません";
}
```

郵便番号の表記（数字三桁、ハイフン、数字四桁）

```
"/^[0-9]{3}-[0-9]{4}$/"
```

使用例

```php
$m = "107-0052";
if (preg_match("/^[0-9]{3}-[0-9]{4}$/", $m)) {
    print "OKです";
} else {
    print "誤りがあります";
}
```

など、組み合わせると文字列が望む条件を満たしているか確認するのにとても便利です。

実践として、`keijiban_delete.php`の入力を数字以外できないように変更しましょう。`try`カッコ内のコードだけ書きます。

```php
...

try {
    $dbh = new PDO($dsn, $user, $password);
    
    // この下にプログラムを書きましょう。
    $number = $_POST["bangou"];

    if (preg_match("/[^0-9]/", $number)) {
        print "数字以外は入力しないでください。";
    } else {
        $dbh->query("DELETE FROM keijiban_tb1 WHERE bangou = {$number};");
    }
}

...
```

それでは練習で`keijiban_insert.php`の入力に「=」が使えないように正規表現で条件分岐をしてみましょう！

### 意図しないタグを実行させない

フォーム内には自由に文字列を入力できます。SQLインジェクション以外にも害ある文字列の入力法があります。それがタグを利用した入力です。試しに以下の文字列を「`okuri.html`」のフォームに入力してください。

```html
<body bgcolor="black">
```

するとなんと、「`uke.php`」のページが真っ黒に表示されてしまいました。このくらいのいたずらだとまったく害はありませんが、タグの中には危険なプログラムを書き込める「`<script>`」タグがあります。これを上手に使われてしまうと、みんなが作ったウェブアプリを通して、ほかの人を攻撃することができてしまいます。

この対策に役に立つ関数が

```php
htmlspecialchars(文字列)
```

という関数です。これは一般的によく攻撃に使用される文字をプログラムで実行できないように入れ替えるものです。教科書の４６８ページを見るとどのような記号を変えているかを見れます。

基本的な使用法はフォームで入力された文字列を一度この関数に通す方法です。

例）

```
$anzen_a = htmlspecialchars($_POST["a"]);
```

という風にPOST変数から危険な記号を変更させます。

これを通せばさっきの画面を黒くする攻撃も回避することができます。

以上でいくつかの攻撃方法とその対策を見てきました。これ以外にもたくさんの攻撃があり、すべてを予測してプログラムを書くことはできません。しかし、少しでも対策をしておくとより防御力が高く、利用者も安心して使えるサイトができます。忘れないようにしましょう。