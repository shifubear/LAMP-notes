# 第２２講 

### 講義ノート
    https://github.com/shifubear/LAMP-notes/

## 掲示板を作ってみよう

掲示板を作る上で実装したい機能は何があるでしょうか？

一番簡単な掲示板で考えられる機能として次の３つの基本的な機能があると思います。

1. 掲示板の表示
    
    当たり前に感じるかもしれないけど、サイトやプログラムを作っていく上ではこのような「当たり前」の機能をしっかり把握して計画する必要があります。簡単そうに思える表示機能でも、いつ表示するのか、どこに表示するのか、どの様に表示した情報を並べるのか等考えないといけないことはたくさんあります。

2. メッセージの送信

    掲示板にメッセージを載せられないとあまり意味がないです。メッセージを載せるまでの手順はどの様なものなのか、ユーザ側の立場から考えて実装を心がけましょう。

3. メッセージの削除

    掲示板に載せた投稿を消したい場合があります。削除をどのように実装するか、考えてみましょう。

今回作る掲示板では上記の三つに加えて、検索機能も実装してみたいと思います。掲示板の投稿が増えてくると検索をできると便利なことが多いです。また、掲示板以外でもデータベースを使ったウェブサービスでは検索機能が便利なことが多くあるので、実装経験は必ず役に立つと思います。

それではこのサイトを作るための準備を初めていきましょう。

## 計画

さて、この様なサイトを作る上で、どの様に準備をすればいいのでしょうか？順を追ってみていきましょう。

サイトを構成する要素は大きくバックエンドとフロントエンドの２つに分けることができます。

バックエンドは主にユーザがこのサイトを使用するに当たってサーバー側で行う処理のことです。今回の授業はバックエンド側（Linux,Apache,PHP,MySQL)のスタックについての授業なのでこちらの方を重点的にみていくことになります。

フロントエンドはユーザが実際にそのサイトやアプリを使用しているときに触れるサイトの要素のことです。主にサイトの内容、デザイン、UX（ユーザエクスペリエンスと言ってサイトの使いやすさなどを指す言葉）のことを指します。今回の授業で少しだけ触れたHTML,CSS,JavaScriptが構成する部分です。興味がある人はフロントエンドの技術を学べる良い本やサイトがたくさんあるので挑戦してみてください！

## バックエンド

それでは今回のサイトのバックエンドの計画に入っていきましょう。サイトの機能の計画が終わったあと最初に考えたいことは「どのようなデータを保存したいか」です。今回の掲示板アプリで保存するデータはどのようなものがあるでしょうか？

### データベースの設計

今回作る簡単な掲示板では、メッセージの内容、投稿者の名前を表示させましょう。

投稿者名|メッセージ内容|
:---:|:---:|
namae | message

それぞれを指す変数名をnamae, messageとしました。少し長くなっても、その変数がなんのデータを格納しているか一目でわかるように名前をつけることは大事です。

このカラムの項目で十分なのか、今回実装予定の機能を一つ一つ見ながら確認してみましょう。

1. 掲示板の表示

    上記の２項目を表示できれば最低限の掲示板は作れそうですね！

2. メッセージの送信

    メッセージを送信した時、投稿者名とメッセージ内容はユーザが入力できるようにしたいですね。実装するときにその点だけ頭に入れておけばこの２項目で十分そうです。

3. メッセージの削除

    ここで少し問題が起こります。メッセージを削除するとき、今ある項目を使用してどのように削除するメッセージを指定しますか？投稿者名で削除するメッセージを指定すると、同じ投稿者が複数個の投稿をした場合、どの投稿を消すか特定できません。それではメッセージを使って削除する投稿を指定する場合はどうでしょう？こちらも、同じメッセージが複数個掲示板に載っている場合それらを区別することができません。そのほかにも、メッセージが長くて指定するのが面倒だったり、全角や半角の問題で同じ文字を打ったつもりが、コンピューターが認識してくれないなど様々なトラブルが起こり得ます。

    それではこの問題をどう解決しましょう？簡単な解決方法の一つで、新しくメッセージに番号を振り分けるためのカラムを作ることがあります。ユーザの入力関係なしに、新しい投稿が載るたびに一つ大きい数字を振り分ければ、削除するときに投稿を簡単に指定することができます。

    また、このカラムを追加したことによって前の機能を妨害するようなことはありません。

4. 検索

    最後に、検索機能を使用する場合、メッセージ内容と投稿者名以外の情報は必要がなさそうですね。

これで今回使用するデータベースの設計図が以下のようにできました。

|投稿番号|投稿者名|メッセージ内容|
|:---:|:---:|:---:|
|bangou |namae | message|

このように、使いたいデータの確認をして、そのデータで計画した機能を全て実装できるかを確認することによってサイトを作る準備をすることができます。今はちょっと遠回りに感じるかもしれませんが、後から機能を拡張したり、データの保存の構造を変更することは結構大変です。

最後に、各カラムに使用するデータ型を考えてみましょう。

投稿者名とメッセージはもちろん文字列型になります。文字列型でも、長さを指定する必要があります。投稿者名はどのくらいの長さが適切なのか、メッセージの長さの制限をどのくらいにするかも考える必要があります。今回は名前を５０文字まで、メッセージを１５０文字までにしましょう。

投稿番号は、整数型で、自動的に連番を挿入するようにしたいです。このようなカラムにぴったりの機能がMySQLに用意されています。前に勉強した「主キー」を使いましょう。

これでデータベースの構図が完成しました。

|投稿番号|投稿者名|メッセージ内容|
|:---:|:---:|:---:|
|INT <br> AUTO_INCREMENT <br> PRIMARY KEY| VARCHAR(50) | VARCHAR(150) | 
|bangou |namae | message|

それではこのテーブルをMySQLで作成してみてください。テーブル名をkeijiban_tbにしましょう。復習になりますが、新しいテーブルを作るためのコマンドは次の通りです：

新しいテーブルの作成
```
CREATE TABLE テーブル名(カラム１名　カラム１型, カラム２名　カラム２型, ...)
```

### ファイル構造

データベースが用意できたら、次は今回使う機能をどのようにファイルで分けるかを少し考えてみましょう。今回みたいに小さいプロジェクトでは簡単な構造で問題ないけど、もっと大きなプロジェクトを作るときは早い段階でプロジェクトの構造を計画する必要があります。

今回は以下のような構造を使います。
```
├── html/ 
│   ├── www/
│   │   ├── keijiban.html
│   │   ├── keijiban_select.php
│   │   ├── keijiban_insert.php
│   │   ├── keijiban_delete.php
│   │   ├── keijiban_search.php
```

`keijiban.html`は最初にアクセスした時に表示するページです。ここから他の４つの機能を呼び出せるようにするのが目的です。それぞれの機能は別々のファイルに入れて管理しやすいようにしました。

それでは早速`keijiban.html`から作っていきましょう。

```
<!DOCTYPE html>
<html>
<head>
</head>
<body>

</body>
</html>
```

この`<body>`の中に各機能を行うためのフォームを入れていきます。

1. 表示のスクリプトを呼び出すフォーム

    ```
    <form method="POST" action="____________.php">
    <div>掲示板内のメッセージを表示します</div>
    <input type="submit" value="メッセージ表示">
    </form>
    ```

2. 挿入のスクリプトを呼び出すフォーム

    ```
    <form method="POST" action="____________.php">
    <div>
    名前を入力してください<input type="text" name="namae">
    </div>
    <div>
    メッセージを入力してください<input type="text" name="message" size="150">
    </div>
    <input type="submit" value="メッセージ投稿">
    </form>
    ```

3. 削除のスクリプトを呼び出すフォーム

    ```
    <form method="POST" action="____________.php">
    <div>
    削除する番号を入力してください<input type="text" name="bangou">
    </div>
    <input type="submit" value="削除">
    </form>
    ```
    
4. 検索のスクリプトを呼び出すフォーム

    ```
    <form method="POST" action="____________.php">
    <div>
    検索のキーワードを入力してください<input type="text" name="search">
    </div>
    <input type="submit" value="検索">
    </form>
    ```

上のフォームを全てHTMLファイルに入れることができたら、どのように表示されているかを確認してみましょう。

### PHP

ここからが本番です！実際にPHPのファイルを作成していきましょう。４つのファイルがありますが、４つ全て「型」は同じです。基本は以下のコードをコピーして、そこから残りのプログラムを書いていきましょう。

```
<?php
header('Content-Type: text/html;charset=utf-8');  // 日本語が正しく表示されるようにいれる

/* Connect to a MySQL database using driver invocation */
$dsn = 'mysql:dbname=db1;host=localhost';
$user = 'root';
$password = 'password';

try { 
    $dbh = new PDO($dsn, $user, $password);
    
    // この下にプログラムを書きましょう。



} catch (PDOException $e) {
    echo 'Connection failed: ' . $e->getMessage();
}

?>
```

今日は残りの部分を今まで学んだことを使って自力で実装してみましょう！困ったときは隣の人か先生に相談してください。
