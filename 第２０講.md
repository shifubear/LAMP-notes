# 第２０講

### MySQLのログイン方法の確認
久しぶりにMySQLを起動してみましょう。今までは```sudo```を使ってMySQLの操作をしてきました。PHPと連携するためにはrootのパスワードを新しく設定する必要があります。
下記のコマンドを書いてパスワードを変更しましょう。

```
$ sudo mysql
mysql> SELECT user,authentication_string FROM mysql.user;
mysql> ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY ‘password’;
mysql> FLUSH PRIVILEGES;
mysql> SELECT user,authentication_string FROM mysql.user;
```


### PHPをMySQLと接続させる
PHPでMySQLを操作するには、PHP内に用意されているPDOというオブジェクトを使って行います。

> __書式__：PDOクラスのオブジェクトを作成する
> ```
> new PDO(データソース名, ユーザ名, パスワード);
> ```

データソース名は以下のように記述します。
```
ドライバ名:host=ホスト名;dbname=データベース名
```

今回の授業ではMySQLを使っているので、
- ドライバ名：mysql
- ホスト名：localhost
- データベース名：db1
を使いましょう。将来、他のデータベースとつなげたいときはここを変更します。

それではPDOオブジェクトを作ってちゃんと接続できているか確認してみましょう。
新しく「setuzoku.php」という名前のファイルを作って、以下のコードを入れてください。
下線部は各自必要な内容を入力してみてください。

```
<?php
header('Content-Type: text/html;charset=utf-8');  // 日本語が正しく表示されるようにいれる

$dsn = '_____';             // データソース名の設定
$user = '_____';            // ユーザ名
$password = '_____';        // パスワード

try {
    $dbh = new PDO($dsn, $user, $password);  // 新しいPDOを作成する
    print "成功！";                         
} catch (PDOException $e) {
    echo 'Connection failed: ' . $e->getMessage();  // 接続が失敗したときにメッセージを表示する
}
?>
```

コードが書けたら、ブラウザから「setuzoku.php」を開いてみてください。問題がなければ「成功！」と表示されます。
失敗した場合、エラー文が表示されます。エラーに合わせて対処していきましょう。

### PHPのPDOオブジェクトでMySQL文を発行する
PDOオブジェクトを使ってMySQL文を発行するにはqueryメソッドを使います。

> __書式__：queryメソッド
> ```
> PDOオブジェクト->query("実行するSQL文");
> ```

まずはテーブルにレコードを挿入してみましょう。テーブルに新しいレコードを挿入するコマンドは
```
INSERT INTO テーブル名 VALUES(データ１, データ２, ...);
```
でした。

実際に実行してみましょう。
新しく「sounyu.php」というファイルを作成し、以下のコードを入力しましょう。
```
<?php
header('Content-Type: text/html;charset=utf-8');  // 日本語が正しく表示されるようにいれる

$dsn = '_____';             // データソース名の設定
$user = '_____';            // ユーザ名
$password = '_____';        // パスワード

try {
    $dbh = new PDO($dsn, $user, $password);  // 新しいPDOを作成する
    $dbh->query("INSERT INTO tb1 VALUES('K777', 'ピー太郎', 20)");  // 新レコード挿入のコマンドを実行する
    print "成功！";
} catch (PDOException $e) {
    echo 'Connection failed: ' . $e->getMessage();  // 接続が失敗したときにメッセージを表示する
}
?>
```

成功と表示されたら、MySQLモニタを使ってデータが挿入されたか確認してみましょう。
```
$ sudo mysql
mysql> use db1
mysql> SELECT * FROM tb1;
```

### MySQL文の結果をブラウザに表示する
